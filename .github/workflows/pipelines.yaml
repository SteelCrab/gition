# ==============================================================================
# CI/CD Pipeline - Main Workflow
# ==============================================================================
# ì„¤ëª…: Gition í”„ë¡œì íŠ¸ì˜ ë©”ì¸ CI/CD íŒŒì´í”„ë¼ì¸
#
# íŒŒì´í”„ë¼ì¸ êµ¬ì¡°:
#   1. Security Scan  -> ì‹œí¬ë¦¿ ìœ ì¶œ ê²€ì‚¬ (Gitleaks)
#   2. Frontend       -> Node.js ë¹Œë“œ/í…ŒìŠ¤íŠ¸/ë¦°íŠ¸
#   3. Backend        -> Python ë¦°íŠ¸/í…ŒìŠ¤íŠ¸ (70% ì»¤ë²„ë¦¬ì§€)
#   4. Docker Build   -> í”„ë¡ íŠ¸ì—”ë“œ/ë°±ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
#   5. Deploy         -> í”„ë¡œë•ì…˜ ë°°í¬ (main ë¸Œëœì¹˜ë§Œ)
#
# íŠ¸ë¦¬ê±°:
#   - main ë¸Œëœì¹˜ì— push ì‹œ
#   - main ë¸Œëœì¹˜ë¡œ PR ìƒì„± ì‹œ
#
# ì•„í‹°íŒ©íŠ¸:
#   - frontend-dist: í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ê²°ê³¼ë¬¼
#   - backend-coverage: ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸
# ==============================================================================

name: CI/CD Pipeline

on:
  # main ë¸Œëœì¹˜ì— pushë  ë•Œ ì‹¤í–‰
  push:
    branches: [main]
  
  # main ë¸Œëœì¹˜ë¡œì˜ PRì—ì„œ ì‹¤í–‰
  pull_request:
    branches: [main]

# ì „ì—­ í™˜ê²½ ë³€ìˆ˜
env:
  REGISTRY: ghcr.io                      # GitHub Container Registry
  IMAGE_NAME: ${{ github.repository }}   # ì €ì¥ì†Œ ì´ë¦„ (owner/repo)

jobs:
  # ============================================
  # Job 1: Security Scan - ì‹œí¬ë¦¿ ìœ ì¶œ ê²€ì‚¬
  # ============================================
  # Gitleaksë¥¼ ì‚¬ìš©í•˜ì—¬ ì½”ë“œì— ì‹¤ìˆ˜ë¡œ ì»¤ë°‹ëœ API í‚¤,
  # ë¹„ë°€ë²ˆí˜¸, í† í° ë“±ì„ ê°ì§€
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
      # ì „ì²´ Git íˆìŠ¤í† ë¦¬ ì²´í¬ì•„ì›ƒ (ì‹œí¬ë¦¿ ìŠ¤ìº”ì— í•„ìš”)
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # ëª¨ë“  ì»¤ë°‹ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°

      # Gitleaks: ì‹œí¬ë¦¿ íŒ¨í„´ ìŠ¤ìº”
      # - ê°ì§€ ì‹œ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨
      # - .gitleaks.tomlë¡œ ê·œì¹™ ì»¤ìŠ¤í„°ë§ˆì´ì§• ê°€ëŠ¥
      - name: ğŸ” Gitleaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # Job 2: Frontend Build & Test
  # ============================================
  # Node.js í™˜ê²½ì—ì„œ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ, ë¦°íŠ¸, í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  # ë¹Œë“œ ê²°ê³¼ë¬¼ì€ ì•„í‹°íŒ©íŠ¸ë¡œ ì €ì¥ë˜ì–´ Docker ë¹Œë“œì— ì‚¬ìš©
  frontend:
    name: ğŸ¨ Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v6

      # Node.js ì„¤ì • (ë²„ì „ 20, npm ìºì‹œ í™œì„±í™”)
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'      # node_modules ìºì‹±ìœ¼ë¡œ ì†ë„ í–¥ìƒ

      # ì˜ì¡´ì„± ì„¤ì¹˜ (npm ci = clean install, lock íŒŒì¼ ê¸°ì¤€)
      - name: ğŸ“š Install dependencies
        run: npm ci

      # TypeScript íƒ€ì… ì²´í¬ (ì»´íŒŒì¼ ì—†ì´)
      # íƒ€ì… ì˜¤ë¥˜ê°€ ìˆìœ¼ë©´ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨
      - name: ğŸ“ Type Check
        run: npx tsc --noEmit

      # ESLint ë¦°íŠ¸ ê²€ì‚¬
      # --if-present: lint ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ìœ¼ë©´ ê±´ë„ˆëœ€
      - name: ğŸ” Lint
        run: npm run lint --if-present

      # Jest/Vitest í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: ğŸ§ª Test
        run: npm test --if-present

      # Vite í”„ë¡œë•ì…˜ ë¹Œë“œ
      - name: ğŸ—ï¸ Build
        run: npm run build

      # ë¹Œë“œ ê²°ê³¼ë¬¼ì„ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
      # Docker ë¹Œë“œ ë‹¨ê³„ì—ì„œ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ì‚¬ìš©
      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: frontend-dist
          path: dist/
          retention-days: 7  # 7ì¼ í›„ ìë™ ì‚­ì œ

  # ============================================
  # Job 3: Backend Build & Test
  # ============================================
  # Python í™˜ê²½ì—ì„œ ë°±ì—”ë“œ ë¦°íŠ¸, í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  # í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ 70% ë¯¸ë§Œ ì‹œ ì‹¤íŒ¨
  backend:
    name: ğŸ Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v6

      # Python ì„¤ì • (ë²„ì „ 3.11, pip ìºì‹œ í™œì„±í™”)
      - name: ğŸ Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      # ì˜ì¡´ì„± ì„¤ì¹˜ + í…ŒìŠ¤íŠ¸/ë¦°íŠ¸ ë„êµ¬
      - name: ğŸ“š Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-cov flake8 httpx requests

      # Flake8 ë¦°íŠ¸ ê²€ì‚¬ (2ë‹¨ê³„)
      # 1ë‹¨ê³„: ì‹¬ê°í•œ ì˜¤ë¥˜ë§Œ ê²€ì‚¬ (E9, F63, F7, F82)
      # 2ë‹¨ê³„: ì „ì²´ ê²€ì‚¬ (ê²½ê³ ë§Œ, ì‹¤íŒ¨í•˜ì§€ ì•ŠìŒ)
      - name: ğŸ” Lint with flake8
        run: |
          cd backend
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      # Pytest í…ŒìŠ¤íŠ¸ + ì»¤ë²„ë¦¬ì§€ ì¸¡ì •
      # --cov-fail-under=70: 70% ë¯¸ë§Œ ì‹œ ì‹¤íŒ¨
      - name: ğŸ§ª Test with pytest (70% coverage required)
        run: |
          cd backend
          pytest tests/ -v --cov=. --cov-report=xml --cov-report=term-missing --cov-fail-under=70

      # ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      - name: ğŸ“Š Upload coverage report
        uses: actions/upload-artifact@v6
        if: always()  # í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨í•´ë„ ì—…ë¡œë“œ
        with:
          name: backend-coverage
          path: backend/coverage.xml
          retention-days: 7

  # ============================================
  # Job 4: Docker Build & Push
  # ============================================
  # í”„ë¡ íŠ¸ì—”ë“œ/ë°±ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ í›„ GHCRì— í‘¸ì‹œ
  # main ë¸Œëœì¹˜ push ì‹œì—ë§Œ ì‹¤í–‰ (PRì—ì„œëŠ” ìŠ¤í‚µ)
  docker:
    name: ğŸ³ Docker Build
    runs-on: ubuntu-latest
    needs: [frontend, backend]  # frontend, backend ì„±ê³µ í›„ ì‹¤í–‰
    if: github.event_name == 'push'  # push ì´ë²¤íŠ¸ë§Œ (PR ì œì™¸)
    
    # GHCR í‘¸ì‹œë¥¼ ìœ„í•œ ê¶Œí•œ
    permissions:
      contents: read
      packages: write

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v6

      # í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
      # Job 2ì—ì„œ ì—…ë¡œë“œí•œ dist/ í´ë”
      - name: ğŸ“¥ Download frontend artifacts
        uses: actions/download-artifact@v7
        with:
          name: frontend-dist
          path: dist/

      # GitHub ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„ì„ ì†Œë¬¸ìë¡œ ë³€í™˜
      # Docker íƒœê·¸ëŠ” ì†Œë¬¸ìë§Œ í—ˆìš©
      - name: ğŸ“ Convert to lowercase
        id: lowercase
        run: |
          echo "owner=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
          echo "repo=$(echo '${{ github.event.repository.name }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      # Docker Buildx ì„¤ì • (ë©€í‹°í”Œë«í¼ ë¹Œë“œ ì§€ì›)
      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # GHCR ë¡œê·¸ì¸
      - name: ğŸ” Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Docker ë©”íƒ€ë°ì´í„° ì¶”ì¶œ (íƒœê·¸, ë¼ë²¨)
      - name: ğŸ“‹ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      # í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
      # íƒœê·¸: ghcr.io/owner/repo-frontend:sha
      - name: ğŸ—ï¸ Build and push Frontend
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ghcr.io/${{ steps.lowercase.outputs.owner }}/${{ steps.lowercase.outputs.repo }}-frontend:${{ github.sha }}
          cache-from: type=gha      # GitHub Actions ìºì‹œ ì‚¬ìš©
          cache-to: type=gha,mode=max

      # ë°±ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
      # íƒœê·¸: ghcr.io/owner/repo-backend:sha
      - name: ğŸ—ï¸ Build and push Backend
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ghcr.io/${{ steps.lowercase.outputs.owner }}/${{ steps.lowercase.outputs.repo }}-backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # Job 5: Deploy (í”„ë¡œë•ì…˜ ë°°í¬)
  # ============================================
  # main ë¸Œëœì¹˜ì—ì„œë§Œ ì‹¤í–‰ë˜ëŠ” ë°°í¬ ë‹¨ê³„
  # TODO: ì‹¤ì œ ë°°í¬ ëª…ë ¹ì–´ ì¶”ê°€ í•„ìš”
  deploy:
    name: ğŸš€ Deploy
    runs-on: ubuntu-latest
    needs: [docker]          # Docker ë¹Œë“œ ì„±ê³µ í›„ ì‹¤í–‰
    if: github.ref == 'refs/heads/main'  # main ë¸Œëœì¹˜ë§Œ
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v6

      # ë°°í¬ ëª…ë ¹ì–´ ì‹¤í–‰
      # TODO: ì‹¤ì œ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì • í•„ìš”
      # ì˜ˆ: kubectl apply, docker-compose pull, SSH ë°°í¬ ë“±
      - name: ğŸš€ Deploy to server
        run: |
          echo "ğŸš€ Deploying to production..."
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          # ì•„ë˜ì— ì‹¤ì œ ë°°í¬ ëª…ë ¹ì–´ ì¶”ê°€
          # ì˜ˆì‹œ:
          # - kubectl set image deployment/frontend frontend=ghcr.io/...
          # - ssh user@server 'docker-compose pull && docker-compose up -d'

      - name: âœ… Deployment complete
        run: echo "âœ… Deployment successful!"
